var FOM,InputStructure,OM,OutputExpression,OutputRule,OutputStructure,Structure,TemplateRule,extend=function(t,e){function r(){this.constructor=t}for(var n in e)hasProp.call(e,n)&&(t[n]=e[n]);return r.prototype=e.prototype,t.prototype=new r,t.__super__=e.prototype,t},hasProp={}.hasOwnProperty,slice=[].slice,indexOf=[].indexOf||function(t){for(var e=0,r=this.length;e<r;e++)if(e in this&&this[e]===t)return e;return-1};"undefined"!=typeof require&&null!==require?(Structure=require("./structure").Structure,InputStructure=require("./input-structure").InputStructure,OM=require("openmath-js").OM,FOM=require("first-order-matching")):"undefined"!=typeof WorkerGlobalScope&&null!==WorkerGlobalScope?(null==WorkerGlobalScope.Structure&&(importScripts("structure.js"),importScripts("input-structure.js")),null==WorkerGlobalScope.OM&&importScripts("openmath.js"),null==WorkerGlobalScope.metavariableSymbol&&importScripts("first-order-matching.js")):null!=("undefined"!=typeof self&&null!==self?self.importScripts:void 0)&&(null==self.Structure&&(importScripts("release/structure.js"),importScripts("release/input-structure.js")),null==self.OM&&importScripts("node_modules/openmath-js/openmath.js"),null==self.metavariableSymbol&&importScripts("node_modules/first-order-matching/first-order-matching.js")),OutputStructure=function(t){function e(){var t,r,n;e.__super__.constructor.apply(this,arguments),this.markDirty(),(r=null!=(n=(t=Structure.prototype.subclasses.InputStructure).prototype.instancesBeingInterpreted)?n.length:void 0)&&(this.origin=t.prototype.instancesBeingInterpreted[r-1]),this.enableFeedback(!0,!1)}return extend(e,Structure),e.prototype.className=Structure.addSubclass("OutputStructure",e),e.prototype.markDirty=function(t){return null==t&&(t=!0),this.dirty=t},e.prototype.addConnectionOrigin=function(t,r,n){var i,u,s;if(i=Structure.prototype.subclasses.InputStructure,r instanceof e&&(u=null!=(s=i.prototype.instancesBeingInterpreted)?s.length:void 0))return n._origin=i.prototype.instancesBeingInterpreted[u-1].id()},e.prototype.feedback=function(t){var e;return this.sendingFeedback?null!=(e=this.origin)?e.feedback(t):void 0:this.feedbackStore.push(t)},e.prototype.enableFeedback=function(t,e){var r,n,i,u;if(null==t&&(t=!0),null==e&&(e=!1),(this.sendingFeedback=t)&&e)for(n=0,i=(u=this.feedbackStore).length;n<i;n++)r=u[n],this.feedback(r);return this.feedbackStore=[]},e.prototype.hasLabel=function(t){return!1},e.lookUpIn=function(t,e){var r,n,i,u;for(n=0,i=(u=e.slice(0).reverse()).length;n<i;n++)if((r=u[n]).hasLabel(t))return r},e.prototype.lookUp=function(t){return this.firstAccessible(function(e){return e.hasLabel(t)})},e.prototype.lookUpAll=function(t){return this.allAccessibles(function(e){return e.hasLabel(t)})},e.prototype.lookUpAllCitations=function(){var t,e,r,n,i,u,s,a,o,l,c,p,h,f,d,g,y,b,v,O,m,M;for(O={premises:{connections:[],labels:[]},reasons:{connections:[],labels:[]}},n=0,a=(g=this.getConnectionsOut()).length;n<a;n++)for(e=g[n],r=this.getConnectionData(e),i=0,o=(y=["premise","reason"]).length;i<o;i++)M=y[i],(null!=r?r.type:void 0)===M+" citation"&&null!=(m=this.getConnectionTarget(e))&&O[M+"s"].connections.push({cited:m.id(),id:e});for(h=0,l=(b=["premise","reason"]).length;h<l;h++)if(M=b[h],(s=this.getAttribute(M+" citations"))&&s instanceof Array)for(f=0,c=s.length;f<c;f++)for(u=s[f],d=0,p=(v=this.lookUpAll(u).reverse()).length;d<p;d++)t=v[d],O[M+"s"].labels.push({cited:t.id(),label:u});return O},e.prototype.justChanged=function(){var t;return"function"==typeof(t=e.prototype).instanceJustChanged?t.instanceJustChanged(this):void 0},e}(),OutputExpression=function(t){function e(){var t,r;switch(r=arguments[0],t=2<=arguments.length?slice.call(arguments,1):[],r){case"int":case"flo":case"str":case"byt":case"var":e.__super__.constructor.call(this),this.setAttribute("OM type",r),this.setAttribute("OM atomic value",t[0]);break;case"sym":e.__super__.constructor.call(this),this.setAttribute("OM type",r),this.setAttribute("OM atomic value",t);break;case"bin":e.__super__.constructor.apply(this,t.slice(1)),this.setAttribute("OM type",r),this.setAttribute("OM bound indices",t[0]);break;case"app":case"err":e.__super__.constructor.apply(this,t),this.setAttribute("OM type",r);break;default:e.__super__.constructor.call(this),this.setAttribute("OM type","err")}}return extend(e,OutputStructure),e.prototype.className=Structure.addSubclass("OutputExpression",e),e.prototype.toOpenMath=function(t){var e,r,n,i,u,s,a,o,l,c,p,h,f,d;if(null==t&&(t=!1),p=function(){switch(h=this.getAttribute("OM type")){case"int":case"flo":case"str":case"byt":case"var":return new OM[h](this.getAttribute("OM atomic value"));case"sym":return function(t,e,r){r.prototype=t.prototype;var n=new r,i=t.apply(n,e);return Object(i)===i?i:n}(OM[h],this.getAttribute("OM atomic value"),function(){});case"app":case"err":return n=function(){var e,n,i,u;for(u=[],e=0,n=(i=this.children()).length;e<n;e++)r=i[e],u.push(r.toOpenMath(t));return u}.call(this),function(t,e,r){r.prototype=t.prototype;var n=new r,i=t.apply(n,e);return Object(i)===i?i:n}(OM[h],n,function(){});case"bin":return s=this.getAttribute("OM bound indices"),d=function(){var t,e,r;for(r=[],t=0,e=s.length;t<e;t++)u=s[t],r.push(OM.var(this.children()[u].getAttribute("OM atomic value")));return r}.call(this),l=function(){var t,e,r;for(r=[],u=t=0,e=this.children().length;0<=e?t<e:t>e;u=0<=e?++t:--t)indexOf.call(s,u)<0&&r.push(u);return r}.call(this),i=this.children()[l[0]].toOpenMath(t),e=this.children()[l[1]].toOpenMath(t),function(t,e,r){r.prototype=t.prototype;var n=new r,i=t.apply(n,e);return Object(i)===i?i:n}(OM.bin,[i].concat(slice.call(d),[e]),function(){});default:throw"Not a valid OpenMath type: "+h}}.call(this),t){c=this.attributes;for(a in c)hasProp.call(c,a)&&(f=c[a],"id"!==a&&"_"!==a[0]&&(o=OM.encodeAsIdentifier(a),p.setAttribute(OM.sym(o,"Lurch"),OM.str(JSON.stringify([f])))))}return p},e.fromOpenMath=function(t,r){var n,i,u,s,a,o,l,c,p,h,f;if(null==r&&(r=!1),u=function(){var n,u,s,a;for(a=[],n=0,u=(s=t.children).length;n<u;n++)i=s[n],a.push(e.fromOpenMath(i,r));return a}(),c=function(){var i;switch(t.type){case"i":return new e("int",t.value);case"f":return new e("flo",t.value);case"st":return new e("str",t.value);case"ba":return new e("byt",t.value);case"sy":return new e("sym",t.name,t.cd,t.uri);case"v":return new e("var",t.name);case"a":return function(t,e,r){r.prototype=t.prototype;var n=new r,i=t.apply(n,e);return Object(i)===i?i:n}(e,["app"].concat(slice.call(u)),function(){});case"bi":return f=function(){var r,n,i,u;for(u=[],r=0,n=(i=t.variables).length;r<n;r++)p=i[r],u.push(new e("var",p.name));return u}(),a=e.fromOpenMath(t.symbol,r),n=e.fromOpenMath(t.body,r),function(t,e,r){r.prototype=t.prototype;var n=new r,i=t.apply(n,e);return Object(i)===i?i:n}(e,["bin",function(){i=[];for(var t=1,e=u.length;1<=e?t<e:t>e;1<=e?t++:t--)i.push(t);return i}.apply(this),a].concat(slice.call(f),[n]),function(){});case"e":return function(t,e,r){r.prototype=t.prototype;var n=new r,i=t.apply(n,e);return Object(i)===i?i:n}(e,["err",e.fromOpenMath(t.symbol,r)].concat(slice.call(u)),function(){});default:throw"This should never happen - how did an OMNode instance get type "+t.type+"?"}}(),r){l=t.tree.a;for(o in l)if(hasProp.call(l,o)){h=l[o];try{s=OM.decodeIdentifier(OM.decode(o).name),c.setAttribute(s,JSON.parse(h.v)[0])}catch(t){}}}return c},e}(),OM.prototype.toOutputExpression=function(t){return OutputExpression.fromOpenMath(this,t)},OutputRule=function(t){function e(){return e.__super__.constructor.apply(this,arguments)}return extend(e,OutputStructure),e.prototype.className=Structure.addSubclass("OutputRule",e),e.prototype.validateStep=function(t,e,r){return t.feedback({type:"validation result",validity:"indeterminate",message:"No real validation was performed."}),r()},e.basicValidate=function(t,r){var n,i;return this.enableFeedback(!1),i=this.lastCitationLookup.reasons,i=i.connections.concat(i.labels),(n=function(u){return function(){var s,a,o;return 0===i.length?(s=u.feedbackStore,u.enableFeedback(!0,!1),s.length>1?u.feedback({type:"validation result",validity:"invalid",components:s}):1===s.length&&u.feedback(s[0]),r()):(a=i.shift(),null==(o=Structure.instanceWithID(a.cited))?(u.enableFeedback(!0,!1),u.feedback({type:"validation result",validity:"invalid",message:"Internal error: No Structure with ID "+a.cited,missingID:a.cited}),r()):o instanceof e?o.validateStep(u,t,function(){var t;return"valid"===(null!=(t=u.feedbackStore[u.feedbackStore.length-1])?t.validity:void 0)?(u.enableFeedback(!0,!1),u.feedback(t),r()):n()}):(u.enableFeedback(!0,!1),u.feedback({type:"validation result",validity:"invalid",message:"You cited a non-rule as a reason.",nonRule:a.cited}),r()))}}(this))()},e}(),TemplateRule=function(t){function e(){return e.__super__.constructor.apply(this,arguments)}return extend(e,OutputRule),e.prototype.className=Structure.addSubclass("TemplateRule",e),e.prototype.validateStep=function(t,r,n){var i,u,s,a,o,l,c,p,h,f,d,g,y,b,v,O,m,M,S,k;for(O=function(){var t,e,r,n;for(n=[],t=0,e=(r=this.children()).length;t<e;t++)(u=r[t]).getAttribute("premise")&&n.push(u.toOpenMath(!0));return n}.call(this),v=function(){var t,e,r,n;for(n=[],t=0,e=(r=this.children()).length;t<e;t++)(u=r[t]).getAttribute("premise")||n.push(u.toOpenMath(!0));return n}.call(this),f=v.length,this.getAttribute("iff")&&(f+=O.length),i=function(t,e){var r;return OM.app.apply(OM,[OM.sym("Rule","Lurch")].concat(slice.call(function(){var e,n,i;for(i=[],e=0,n=t.length;e<n;e++)r=t[e],i.push(r.copy());return i}()),[e.copy()]))},a=function(t){var e,r,n,u,s,a,o;for(t<v.length?(u=O,e=v[t]):(u=v,e=O[t-v.length]),r=0,n=(o=(s=i(u,e)).descendantsSatisfying(function(t){return"v"===t.type})).length;r<n;r++)a=o[r],FOM.setMetavariable(a);return s},t instanceof OutputExpression||t.feedback({type:"validation result",validity:"invalid",message:"Conclusion is not an expression"}),g=[],l=0,p=(y=["connections","labels"]).length;l<p;l++)for(S=y[l],c=0,h=(b=t.lastCitationLookup.premises[S]).length;c<h;c++){if(s=b[c],!((d=Structure.instanceWithID(s.cited))instanceof OutputExpression))return t.feedback({type:"validation result",validity:"invalid",message:"Cited premise is not an expression",id:s.cited}),n();g.push(d.toOpenMath(!0))}return o=i(g,t.toOpenMath(!0)),m="string"===this.getAttribute("matching type")?"string":"tree",M="tree"===m?o.encode():function(){var t,e,r,n;for(n=[],e=0,t=(r=o.children.slice(1)).length;e<t;e++)k=r[e],n.push(k.value);return n}(),this.setupWorker(r,{step:M},n,function(i){return function(){var s,o;return s=0,(o=function(){var l,c;return s===f?(t.feedback({type:"validation result",validity:"invalid",message:"Cited rule does not justify the step"}),n()):(c=e[m+"BasedPatternMatching"],l=function(){var t,e,r,n;if("tree"===m)return a(s).encode();for(n=[],e=0,t=(r=a(s).children.slice(1)).length;e<t;e++)u=r[e],n.push(u.toOutputExpression(!0).getAttribute("string pattern"));return n}(),i.setupWorker(r,{rule:l},n,function(){return r.run(c,function(e){return null!=e.error?(t.feedback({type:"validation result",validity:"invalid",message:"Internal error in pattern matching",details:e.error}),n()):null!=e.result?(t.feedback({type:"validation result",validity:"valid"}),n()):(s++,o())})}))})()}}(this))},e.prototype.setupWorker=function(t,r,n,i){var u,s,a,o,l;return u=function(t){return function(e,r){var i;return i={type:"validation result",validity:"invalid",message:"Internal error setting up validation worker: could not "+e},null!=r&&(i.details=r),t.feedback(i),n()}}(this),o=function(){var t;t=[];for(s in r)hasProp.call(r,s)&&(l=r[s],t.push(s));return t}(),(a=function(n){return function(){var s;return o.length>0?(s=o.shift(),t.installData(s,r[s],function(t){return null!=t.error?u("install "+s):a()})):"string"===n.getAttribute("matching type")?t.run(function(){return typeof stringMatches},function(r){return null!=r.error?u("check string matching installation",r.error):"undefined"===r.result?t.installFunction("stringMatches",e.stringMatches,function(r){return null!=r.error?u("install string matcher",r.error):t.installFunction("stringListMatches",e.stringListMatches,function(t){return null!=t.error?u("install string list matcher",t.error):i()})}):i()}):t.run(function(){return typeof isMetavariable},function(e){var r;return null!=e.error?u("check package status",e.error):"undefined"===e.result?(r="first-order-matching.js","undefined"!=typeof require&&null!==require&&(r="release/"+r),t.installScript(r,function(t){return null!=t.error?u("install matching package",t.error):i()})):i()})}}(this))()},e.stringMatches=function(t,e,r){var n,i,u,s,a,o;if(null==r&&(r={}),0===t.length)return 0===e.length?[JSON.parse(JSON.stringify(r))]:[];if(u=t[0],o=u.text,"string"===u.type)return e.slice(0,o.length)===o?stringMatches(t.slice(1),e.slice(o.length),r):[];if(r.hasOwnProperty(o))return e.slice(0,r[o].length)===r[o]?stringMatches(t.slice(1),e.slice(r[o].length),r):[];for(a=[],n=i=1,s=e.length;1<=s?i<=s:i>=s;n=1<=s?++i:--i)r[o]=e.slice(0,n),a=a.concat(stringMatches(t.slice(1),e.slice(n),r));return delete r[o],a},e.stringListMatches=function(t,e,r){var n,i,u,s,a,o,l,c,p;if(null==r&&(r={}),0===t.length)return 0===e.length?[r]:[];if(0===e.length)return[];for(p=[],n=0,u=(o=stringMatches(t[0],e[0],r)).length;n<u;n++)for(a=o[n],i=0,s=(l=stringListMatches(t.slice(1),e.slice(1),a)).length;i<s;i++)c=l[i],p.push(c);return p},e.treeBasedPatternMatching=function(){var t,e,r,n,i,u,s,a,o,l,c;if(l=OM.decode(globalData.rule),c=OM.decode(globalData.step),i=nextMatch(new Constraint(l,c)),t=null!=i&&null!=(s=i[0])?s.contents:void 0){for(o=[],r=0,n=t.length;r<n;r++)u=(a=t[r]).pattern,e=a.expression,o.push({pattern:u.encode(),expression:e.encode()});return o}return null},e.stringBasedPatternMatching=function(){var t;return(t=stringListMatches(globalData.rule,globalData.step)).length?t[0]:null},e}(),"undefined"!=typeof exports&&null!==exports&&(exports.OutputStructure=OutputStructure,exports.OutputExpression=OutputExpression,exports.OM=exports.OMNode=OM);
//# sourceMappingURL=output-structure.js.map
